

// ===== FILE: api/auth/check.php (SECURE VERSION) =====
<?php
// Prevent direct access
if (!defined('SECURE_ACCESS')) define('SECURE_ACCESS', true);

// Include required files
require_once dirname(__DIR__, 2) . '/config.php';
require_once dirname(__DIR__, 2) . '/auth_functions.php';

header('Content-Type: application/json');
header('Access-Control-Allow-Origin: *');
header('Access-Control-Allow-Credentials: true');

try {
    $pdo = getDBConnection();

    // Check session
    if (isset($_SESSION['user_id']) && isset($_SESSION['session_token'])) {
        // Verify session token
        $stmt = $pdo->prepare("
            SELECT us.*, u.username, u.email, u.role, u.full_name, u.profile_picture 
            FROM user_sessions us 
            JOIN users u ON us.user_id = u.id 
            WHERE us.user_id = ? AND us.session_token = ? 
            AND us.expires_at > NOW() AND u.is_active = 1
        ");
        $stmt->execute([$_SESSION['user_id'], $_SESSION['session_token']]);
        $session = $stmt->fetch(PDO::FETCH_ASSOC);
        
        if ($session) {
            // Update session last activity
            try {
                $stmt = $pdo->prepare("UPDATE user_sessions SET updated_at = NOW() WHERE id = ?");
                $stmt->execute([$session['id']]);
            } catch (PDOException $e) {
                error_log("Session update failed: " . $e->getMessage());
            }
            
            // Determine redirect based on user role
            $redirect = 'dashboard.html';
            if ($session['role'] === 'coach') {
                $redirect = 'coach-dashboard.html';
            } elseif ($session['role'] === 'athlete' || $session['role'] === 'atlet') {
                $redirect = 'athlete-dashboard.html';
            } elseif ($session['role'] === 'admin') {
                $redirect = 'admin-dashboard.html';
            }
            
            jsonResponse([
                'success' => true,
                'data' => [
                    'user' => [
                        'id' => $session['user_id'],
                        'username' => $session['username'],
                        'email' => $session['email'],
                        'role' => $session['role'],
                        'full_name' => $session['full_name'],
                        'profile_picture' => $session['profile_picture']
                    ],
                    'redirect' => $redirect
                ]
            ]);
        }
    }

    // Check remember me token if available
    if (isset($_COOKIE['remember_token'])) {
        // Implement remember me functionality here if needed
    }

    jsonResponse(['success' => false, 'message' => 'Not authenticated']);

} catch (Exception $e) {
    error_log("Auth check error: " . $e->getMessage());
    jsonResponse(['success' => false, 'message' => 'Auth check failed'], 500);
}

// ===== FILE: api/auth/logout.php (SECURE VERSION) =====
<?php
// Prevent direct access
if (!defined('SECURE_ACCESS')) define('SECURE_ACCESS', true);

// Include required files
require_once dirname(__DIR__, 2) . '/config.php';
require_once dirname(__DIR__, 2) . '/auth_functions.php';

header('Content-Type: application/json');
header('Access-Control-Allow-Origin: *');
header('Access-Control-Allow-Methods: POST');
header('Access-Control-Allow-Credentials: true');

try {
    $pdo = getDBConnection();

    if (isset($_SESSION['user_id'])) {
        $user_id = $_SESSION['user_id'];
        $session_token = $_SESSION['session_token'] ?? null;
        
        // Deactivate current session
        if ($session_token) {
            try {
                $stmt = $pdo->prepare("DELETE FROM user_sessions WHERE session_token = ?");
                $stmt->execute([$session_token]);
            } catch (PDOException $e) {
                error_log("Session deletion failed: " . $e->getMessage());
            }
        }
        
        // Log activity
        logActivity($user_id, 'logout', 'User logged out');
        
        // Clear remember token cookie
        if (isset($_COOKIE['remember_token'])) {
            setcookie('remember_token', '', time() - 3600, '/', '', false, true);
        }
    }

    // Destroy session
    session_destroy();

    jsonResponse(['success' => true, 'message' => 'Logout berhasil']);

} catch (Exception $e) {
    error_log("Logout error: " . $e->getMessage());
    jsonResponse(['success' => false, 'message' => 'Logout failed'], 500);
}

// ===== FILE: config.php (UPDATED WITH SECURITY) =====
<?php
// config.php - Secure configuration file

// Prevent direct access
if (!defined('SECURE_ACCESS')) {
    if (basename($_SERVER['PHP_SELF']) === 'config.php') {
        http_response_code(403);
        die('Direct access not allowed');
    }
}

// Mulai session jika belum dimulai
if (session_status() === PHP_SESSION_NONE) {
    session_start();
}

// Environment detection
$isProduction = (isset($_SERVER['HTTP_HOST']) && 
    !in_array($_SERVER['HTTP_HOST'], ['localhost', '127.0.0.1', '::1']));

// Konfigurasi Database
define('DB_HOST', 'localhost');
define('DB_NAME', 'inspant_db');
define('DB_USER', 'root'); // Ganti sesuai setup Anda
define('DB_PASS', ''); // Ganti sesuai setup Anda

// Konfigurasi Aplikasi
define('APP_NAME', 'Inspant');
define('APP_URL', $isProduction ? 'https://yourdomain.com' : 'http://localhost/inspant');
define('UPLOAD_DIR', 'assets/uploads/');

// Konfigurasi Keamanan
define('JWT_SECRET', $isProduction ? 'YOUR_PRODUCTION_SECRET_KEY' : 'dev_secret_key_change_in_production');
define('BCRYPT_COST', 12);
define('SESSION_LIFETIME', 3600 * 24 * 7); // 7 hari
define('MAX_LOGIN_ATTEMPTS', 5);
define('LOGIN_LOCKOUT_TIME', 900); // 15 menit
define('LOGIN_ATTEMPT_TIMEOUT', 900); // 15 menit

// Security headers
if ($isProduction) {
    header('X-Content-Type-Options: nosniff');
    header('X-Frame-Options: DENY');
    header('X-XSS-Protection: 1; mode=block');
    header('Referrer-Policy: strict-origin-when-cross-origin');
}

// Error reporting
if ($isProduction) {
    error_reporting(0);
    ini_set('display_errors', 0);
    ini_set('log_errors', 1);
} else {
    error_reporting(E_ALL);
    ini_set('display_errors', 1);
    define('DEBUG', true);
}

// Timezone
date_default_timezone_set('Asia/Jakarta');

// Database connection with connection pooling
function getDBConnection() {
    static $pdo = null;
    
    if ($pdo === null) {
        try {
            $dsn = "mysql:host=" . DB_HOST . ";dbname=" . DB_NAME . ";charset=utf8mb4";
            $options = [
                PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
                PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
                PDO::ATTR_EMULATE_PREPARES => false,
                PDO::MYSQL_ATTR_INIT_COMMAND => "SET NAMES utf8mb4 COLLATE utf8mb4_unicode_ci",
                PDO::ATTR_PERSISTENT => true, // Connection pooling
            ];
            
            $pdo = new PDO($dsn, DB_USER, DB_PASS, $options);
        } catch (PDOException $e) {
            error_log("Database connection failed: " . $e->getMessage());
            
            if (defined('DEBUG') && DEBUG) {
                die("Database connection failed: " . $e->getMessage());
            } else {
                die("Koneksi database gagal. Silakan coba lagi nanti.");
            }
        }
    }
    
    return $pdo;
}

// Helper function to create tables if not exists
function createTableIfNotExists($pdo, $tableName, $createSQL) {
    try {
        $stmt = $pdo->query("SHOW TABLES LIKE '$tableName'");
        if (!$stmt->fetch()) {
            $pdo->exec($createSQL);
        }
    } catch (PDOException $e) {
        error_log("Table creation failed for $tableName: " . $e->getMessage());
    }
}

// Enhanced input sanitization
function sanitizeInput($input) {
    if (is_array($input)) {
        return array_map('sanitizeInput', $input);
    }
    return htmlspecialchars(strip_tags(trim($input)), ENT_QUOTES, 'UTF-8');
}

// Validate email
function isValidEmail($email) {
    return filter_var($email, FILTER_VALIDATE_EMAIL) !== false;
}

// Generate secure token
function generateSecureToken($length = 32) {
    return bin2hex(random_bytes($length));
}

// Hash password
function hashPassword($password) {
    return password_hash($password, PASSWORD_BCRYPT, ['cost' => BCRYPT_COST]);
}

// Verify password
function verifyPassword($password, $hash) {
    return password_verify($password, $hash);
}

// Check if user is logged in
function isLoggedIn() {
    return isset($_SESSION['user_id']) && isset($_SESSION['session_token']);
}

// Check user role
function hasRole($role) {
    return isset($_SESSION['role']) && $_SESSION['role'] === $role;
}

// Secure redirect
function redirect($url) {
    // Validate URL to prevent open redirect
    if (filter_var($url, FILTER_VALIDATE_URL) === false && !preg_match('/^\/[^\/]/', $url)) {
        $url = '/';
    }
    header("Location: " . $url);
    exit();
}

// JSON response with security headers
function jsonResponse($data, $status_code = 200) {
    http_response_code($status_code);
    header('Content-Type: application/json; charset=utf-8');
    
    // Add security headers for JSON responses
    header('Cache-Control: no-cache, must-revalidate');
    header('Expires: Mon, 26 Jul 1997 05:00:00 GMT');
    
    echo json_encode($data, JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES);
    exit();
}

// Enhanced activity logging
function logActivity($user_id, $action, $details = null) {
    try {
        $pdo = getDBConnection();
        
        // Ensure user_activities table exists
        createTableIfNotExists($pdo, 'user_activities', "
            CREATE TABLE user_activities (
                id INT AUTO_INCREMENT PRIMARY KEY,
                user_id INT NOT NULL,
                action VARCHAR(100) NOT NULL,
                details TEXT,
                ip_address VARCHAR(45),
                user_agent TEXT,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                INDEX idx_user_id (user_id),
                INDEX idx_action (action),
                INDEX idx_created_at (created_at)
            )
        ");
        
        $stmt = $pdo->prepare("
            INSERT INTO user_activities (user_id, action, details, ip_address, user_agent) 
            VALUES (?, ?, ?, ?, ?)
        ");
        
        $ip = $_SERVER['HTTP_X_FORWARDED_FOR'] ?? $_SERVER['REMOTE_ADDR'] ?? 'unknown';
        $user_agent = $_SERVER['HTTP_USER_AGENT'] ?? 'unknown';
        
        $stmt->execute([$user_id, $action, $details, $ip, $user_agent]);
    } catch (Exception $e) {
        error_log("Failed to log activity: " . $e->getMessage());
    }
}

// Enhanced rate limiting
function checkLoginAttempts($ip, $username = null) {
    try {
        $pdo = getDBConnection();
        
        // Ensure login_attempts table exists
        createTableIfNotExists($pdo, 'login_attempts', "
            CREATE TABLE login_attempts (
                id INT AUTO_INCREMENT PRIMARY KEY,
                ip_address VARCHAR(45) NOT NULL,
                username VARCHAR(255),
                success BOOLEAN NOT NULL DEFAULT 0,
                attempted_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                INDEX idx_ip_time (ip_address, attempted_at),
                INDEX idx_username_time (username, attempted_at)
            )
        ");
        
        // Check attempts based on IP
        $stmt = $pdo->prepare("
            SELECT COUNT(*) as attempts 
            FROM login_attempts 
            WHERE ip_address = ? 
            AND success = FALSE 
            AND attempted_at > DATE_SUB(NOW(), INTERVAL ? SECOND)
        ");
        $stmt->execute([$ip, LOGIN_ATTEMPT_TIMEOUT]);
        $ip_attempts = $stmt->fetchColumn();
        
        if ($ip_attempts >= MAX_LOGIN_ATTEMPTS) {
            return false;
        }
        
        // Check attempts based on username if provided
        if ($username) {
            $stmt = $pdo->prepare("
                SELECT COUNT(*) as attempts 
                FROM login_attempts 
                WHERE username = ? 
                AND success = FALSE 
                AND attempted_at > DATE_SUB(NOW(), INTERVAL ? SECOND)
            ");
            $stmt->execute([$username, LOGIN_ATTEMPT_TIMEOUT]);
            $username_attempts = $stmt->fetchColumn();
            
            if ($username_attempts >= MAX_LOGIN_ATTEMPTS) {
                return false;
            }
        }
        
        return true;
    } catch (Exception $e) {
        error_log("Failed to check login attempts: " . $e->getMessage());
        return true; // Allow login if check fails
    }
}

// Record login attempt
function recordLoginAttempt($ip, $username, $success) {
    try {
        $pdo = getDBConnection();
        $stmt = $pdo->prepare("
            INSERT INTO login_attempts (ip_address, username, success) 
            VALUES (?, ?, ?)
        ");
        $stmt->execute([$ip, $username, $success]);
    } catch (Exception $e) {
        error_log("Failed to record login attempt: " . $e->getMessage());
    }
}

// Cleanup expired data
function cleanupExpiredData() {
    try {
        $pdo = getDBConnection();
        
        // Delete expired sessions
        $pdo->exec("DELETE FROM user_sessions WHERE expires_at < NOW()");
        
        // Delete old login attempts (older than 24 hours)
        $pdo->exec("DELETE FROM login_attempts WHERE attempted_at < DATE_SUB(NOW(), INTERVAL 24 HOUR)");
        
    } catch (Exception $e) {
        error_log("Failed to cleanup expired data: " . $e->getMessage());
    }
}

// Run cleanup randomly (1% chance)
if (rand(1, 100) === 1) {
    cleanupExpiredData();
}

// ===== FILE: create_database.php (Database Setup Script) =====
<?php
// Script untuk membuat database dan tabel yang diperlukan
// Jalankan sekali untuk setup database

define('SECURE_ACCESS', true);

header('Content-Type: application/json');

try {
    // Koneksi tanpa database untuk membuat database
    $pdo = new PDO("mysql:host=localhost;charset=utf8mb4", 'root', '');
    $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
    
    // Buat database jika belum ada
    $pdo->exec("CREATE DATABASE IF NOT EXISTS inspant_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci");
    $pdo->exec("USE inspant_db");
    
    // Buat tabel users
    $pdo->exec("
        CREATE TABLE IF NOT EXISTS users (
            id INT AUTO_INCREMENT PRIMARY KEY,
            username VARCHAR(50) NOT NULL UNIQUE,
            email VARCHAR(100) NOT NULL UNIQUE,
            password_hash VARCHAR(255) NOT NULL,
            full_name VARCHAR(100) NOT NULL,
            phone VARCHAR(20),
            role ENUM('admin', 'coach', 'athlete', 'atlet') NOT NULL DEFAULT 'atlet',
            email_verified BOOLEAN DEFAULT FALSE,
            is_active BOOLEAN DEFAULT TRUE,
            profile_picture VARCHAR(255),
            date_of_birth DATE,
            gender ENUM('male', 'female', 'other'),
            address TEXT,
            emergency_contact VARCHAR(100),
            emergency_phone VARCHAR(20),
            last_login TIMESTAMP NULL,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
            INDEX idx_username (username),
            INDEX idx_email (email),
            INDEX idx_role (role),
            INDEX idx_active (is_active)
        ) ENGINE=InnoDB
    ");
    
    // Buat tabel user_sessions
    $pdo->exec("
        CREATE TABLE IF NOT EXISTS user_sessions (
            id INT AUTO_INCREMENT PRIMARY KEY,
            user_id INT NOT NULL,
            session_token VARCHAR(64) NOT NULL UNIQUE,
            ip_address VARCHAR(45),
            user_agent TEXT,
            expires_at TIMESTAMP NOT NULL,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
            FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
            INDEX idx_token (session_token),
            INDEX idx_user_id (user_id),
            INDEX idx_expires (expires_at)
        ) ENGINE=InnoDB
    ");
    
    // Buat tabel login_attempts
    $pdo->exec("
        CREATE TABLE IF NOT EXISTS login_attempts (
            id INT AUTO_INCREMENT PRIMARY KEY,
            ip_address VARCHAR(45) NOT NULL,
            username VARCHAR(255),
            success BOOLEAN NOT NULL DEFAULT 0,
            attempted_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            INDEX idx_ip_time (ip_address, attempted_at),
            INDEX idx_username_time (username, attempted_at)
        ) ENGINE=InnoDB
    ");
    
    // Buat tabel user_activities
    $pdo->exec("
        CREATE TABLE IF NOT EXISTS user_activities (
            id INT AUTO_INCREMENT PRIMARY KEY,
            user_id INT NOT NULL,
            action VARCHAR(100) NOT NULL,
            details TEXT,
            ip_address VARCHAR(45),
            user_agent TEXT,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
            INDEX idx_user_id (user_id),
            INDEX idx_action (action),
            INDEX idx_created_at (created_at)
        ) ENGINE=InnoDB
    ");
    
    // Buat user test
    $testUsers = [
        [
            'username' => 'admin',
            'email' => 'admin@inspant.com',
            'password' => 'admin123',
            'full_name' => 'Administrator',
            'role' => 'admin'
        ],
        [
            'username' => 'coach1',
            'email' => 'coach@inspant.com',
            'password' => 'coach123',
            'full_name' => 'Coach Test',
            'role' => 'coach'
        ],
        [
            'username' => 'atlet1',
            'email' => 'atlet@inspant.com',
            'password' => 'atlet123',
            'full_name' => 'Atlet Test',
            'role' => 'atlet'
        ]
    ];
    
    $created = [];
    foreach ($testUsers as $user) {
        try {
            $stmt = $pdo->prepare("SELECT id FROM users WHERE username = ? OR email = ?");
            $stmt->execute([$user['username'], $user['email']]);
            
            if (!$stmt->fetch()) {
                $stmt = $pdo->prepare("
                    INSERT INTO users (username, email, password_hash, full_name, role, is_active, email_verified) 
                    VALUES (?, ?, ?, ?, ?, 1, 1)
                ");
                $stmt->execute([
                    $user['username'],
                    $user['email'],
                    password_hash($user['password'], PASSWORD_BCRYPT),
                    $user['full_name'],
                    $user['role']
                ]);
                
                $created[] = [
                    'username' => $user['username'],
                    'email' => $user['email'],
                    'password' => $user['password'],
                    'role' => $user['role']
                ];
            }
        } catch (Exception $e) {
            // Skip if user already exists
        }
    }
    
    echo json_encode([
        'success' => true,
        'message' => 'Database and tables created successfully',
        'created_users' => $created
    ], JSON_PRETTY_PRINT);
    
} catch(PDOException $e) {
    echo json_encode([
        'success' => false,
        'message' => 'Database setup failed',
        'error' => $e->getMessage()
    ]);
}
?>